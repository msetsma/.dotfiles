# ==============================================================================
# Makefile.toml - Main Installation & Setup Tasks
# ==============================================================================
# This file handles initial setup and tool installation.
# For daily operations and utilities, see Makefile.utils.toml
#
# Quick start:
#     $ cargo make help               # Show most common commands
#     $ cargo make init               # Initial setup
#     $ cargo make deploy-and-backup  # Deploy dotfiles + git backup
#
# More commands:
#     $ cargo make update             # Update all tools
#     $ cargo make info               # See all available commands
#     $ cargo make doctor             # Check system health
# ==============================================================================

# Import utility tasks
extend = "Makefile.utils.toml"


# ==========================
# ==== Main Setup Task =====
# ==========================
[tasks.init]
description = "Set up the development environment"
dependencies = [
    "install-rust",       # Install Rust and its components
    "install-tools",      # Install platform-specific tools
    "install-coreutils",  # Install platform-specific coreutils
    "install-rust-tools", # Install additional Rust tools
    "dotfiles",           # Symlink dotfiles
]

[tasks.install-rust]
description = "Install Rust toolchain components."
script = [
    "rustup component add clippy",
    "rustup component add rustfmt"
]

[tasks.install-rust-tools]
script = [
    "cargo install mise",
    "cargo install dotter",
    "cargo install cargo-update",
    "cargo install vivid",
    "cargo install eza",
    "cargo install bottom",
    "cargo install bat",
]

# Platform-Specific Coreutils Installation
[tasks.install-coreutils]
windows_alias = "windows-core-utils"
mac_alias = "mac-core-utils"

[tasks.windows-core-utils]
condition = { platforms = ["windows"] }
script = [
    "cargo install coreutils --features windows"
]

[tasks.mac-core-utils]
condition = { platforms = ["mac"] }
script = [
    "cargo install coreutils --features macos"
]

# Platform-Specific Tool Installation
[tasks.install-tools]
windows_alias = "windows-tools"
mac_alias = "mac-tools"

[tasks.windows-tools]
script = [
#    "echo --- Scoop Setup ---",
#    "echo Adding Scoop buckets...",
#    "scoop bucket add extras || true",
#    "scoop bucket add nerd-fonts || true",
#    "scoop bucket add versions || true",

    "echo --- Installing Tools ---",
    "scoop install lazygit neovim yazi wezterm-nightly fzf ripgrep bat",

    "echo --- Installing Languages ---",
    "scoop install python go lua lua51 luarocks stylua",

    "echo --- Installing Dependencies ---",
    "scoop install autohotkey gcc cmake fastfetch firacode",
    "scoop shim add gcc ~\\scoop\\apps\\gcc\\current\\bin\\gcc.exe", # Needed for NVim Telescope FZF Native

    "echo --- Installing Python Package Manager ---",
    "python -m pip install --user pipx",
    "python -m pipx ensurepath",

    "echo --- Installing Scoopfile (if exists) ---",
    "if exist %USERPROFILE%\\.dotfiles\\scoopfile.json (",
    "  for /f \"tokens=1\" %%i in (%USERPROFILE%\\.dotfiles\\scoopfile.json) do scoop install %%i 2>nul || echo Skipping %%i",
    ")",

    "echo --- Installing pipx packages (if exists) ---",
    "if exist %USERPROFILE%\\.dotfiles\\pipx-requirements.txt (",
    "  for /f %%p in (%USERPROFILE%\\.dotfiles\\pipx-requirements.txt) do pipx install %%p 2>nul || echo Skipping %%p",
    ")",

    "echo --- Setting Environment Variables ---",
    'setx XDG_CONFIG_HOME "%USERPROFILE%\\.config"', # Nushell home directory
    'setx YAZI_CONFIG_HOME "%USERPROFILE%\\.config\\yazi"', # Yazi config file
]

[tasks.mac-tools]
script = [
    "echo '--- Installing Tools ---'",
    "brew install yazi lazygit bat fzf ripgrep fd fastfetch cmake openssl nvim",
    "brew install --cask nikitabobko/tap/aerospace",
    'sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"',

    "echo '--- Installing Languages ---'",
    "brew install lua lua51 luarocks go python node",

    "echo '--- Managing Fonts ---'",
    "brew tap homebrew/cask-fonts",
    "brew install --cask font-fira-code",

    "echo '--- Installing Python Package Manager ---'",
    "python3 -m pip install --user pipx",
    "python3 -m pipx ensurepath",

    "echo '--- Installing Brewfile (if exists) ---'",
    "if [ -f ~/.dotfiles/Brewfile ]; then",
    "  brew bundle --file=~/.dotfiles/Brewfile || echo 'Some Brewfile packages may have failed'",
    "fi",

    "echo '--- Installing pipx packages (if exists) ---'",
    "if [ -f ~/.dotfiles/pipx-requirements.txt ]; then",
    "  while read package; do",
    "    pipx install $package 2>/dev/null || echo \"Skipping $package (may already be installed)\"",
    "  done < ~/.dotfiles/pipx-requirements.txt",
    "fi",

    "echo '--- Setting Environment Variables ---'",
    "export YAZI_CONFIG_HOME=\"~/.config/yazi\"",
]

[tasks.dotfiles]
description = "Symlink all the .dotfiles depending on dotter/system.toml files"
script = [
    "echo --- Creating Symlinks ---",
    "dotter -v",
]

# ==========================
# ==== Main Update Task ====
# ==========================
[tasks.update]
description = "Update all tools, dependencies, and configurations"
dependencies = [
    "update-rust",           # Update Rust toolchain and components
    "update-platform-tools", # Update platform-specific tools
    "update-mise",           # Update mise configurations
    "dotfiles",              # Take the chance to validate the dotfiles
]

# Rust Toolchain Update
[tasks.update-rust]
script = [
    "rustup self update",
    "rustup update",
    "cargo install-update -a"
]

# Platform-Specific Tools Update
[tasks.update-platform-tools]
windows_alias = "update-windows-tools"
mac_alias = "update-mac-tools"

[tasks.update-windows-tools]
script = [
    "echo --- Updating Scoop & Packages ---",
    "scoop update",
    "scoop update *",
]

[tasks.update-mac-tools]
script = [
    "echo --- Updating Homebrew & Packages ---",
    "brew update",
    "brew upgrade",
    "brew upgrade --cask wezterm@nightly --no-quarantine --greedy-latest",

]

[tasks.update-mise]
script = ["echo --- Updating Global Mise Packages ---", "mise install"]

# ================================
# ==== Check for Updates Task ====
# ================================
[tasks.check-outdated]
description = "Set up the development environment"
dependencies = [
    "check-outdated-rust",    # Check rustup for updates
    "check-package-managers", # Check platform specific updates
]

[tasks.check-outdated-rust]
script = [
    "echo --- Checking for available updates (without applying) ---",
    "rustup update --no-self-update || echo 'Rustup is up-to-date'",
]

[tasks.check-package-managers]
windows_alias = "check-outdated-windows"
mac_alias = "check-outdated-mac"

[tasks.check-outdated-windows]
script = [
    "echo --- Checking for outdated Scoop packages ---",
    "scoop status || echo 'Scoop not found or not running on Windows'",
]

[tasks.check-outdated-mac]
script = [
    "echo --- Checking for outdated Homebrew packages ---",
    "brew outdated || echo 'No outdated packages found or not running on macOS'",
]
